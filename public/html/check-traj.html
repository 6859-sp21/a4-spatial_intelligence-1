{% extends "layouts/base.html" %}

{% block title %} Boxed Layout {% endblock %} 

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

  <link rel="stylesheet" type="text/css" href="/static/assets/css/jqvmap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <link rel="stylesheet" type="text/css" href="/static/assets/css/zwang-custom.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.4/css/buttons.dataTables.min.css">

{% endblock stylesheets %}

{% block content %}


  <!-- 人流计数 -->
  <div class="yoo-content yoo-style1">

    <!--  -->
    <div class="yoo-height-b30 yoo-height-lg-b30"></div>
    <div class="container">
      <div class="yoo-uikits-heading">
        <h2 class="yoo-uikits-title">人流轨迹查询</h2>
      </div>
    </div>
    <div class="yoo-height-b30 yoo-height-lg-b30"></div>
    <div class="container">
      <div class="row">
         <div class="col-lg-12">
          <div class="yoo-card yoo-style1">
            <div class="yoo-card-heading">
              <div class="yoo-card-heading-left">
                <h2 class="yoo-card-title"><span class="yoo-card-title-icon yoo-gray-bg"><ion-icon name="map"></ion-icon></span>请输入需要查询的楼宇</h2>
              </div>
            </div>
            <div class="yoo-card-body">
              <div class="yoo-padd-lr-20">
                <div class="yoo-height-b20 yoo-height-lg-b20"></div>
                <div class="row" style="width: -webkit-fill-available; height: 60px; margin: 15px;">
                  <div class="col-10" style="overflow: hidden; padding-right: 0;">
                    <div class="row" style="width: -webkit-fill-available; height: 50px;">
                        <select class="col-2 custom-select" id="property_id_selector" style="margin: 0;">
                        </select>
                        <select class="col-2 custom-select" id="floor_id_selector" style="margin: 0; margin-bottom: 15px; width: 100%%">
                        </select>
                        <select class="col-2 custom-select" id="camera_id_selector" style="margin: 0; margin-bottom: 15px; width: 100%%">
                        </select>
                        <input class="col-5 form-control date-selector" type="text" name="daterange" value="10/01/2020 - 10/02/2020" />
                    </div>
                  </div>
                  <div class="col-2" style="overflow: hidden; padding-right: 0;">
                    <button type="button" class="btn btn-primary" id="search-traj" aria-haspopup="true" aria-expanded="false" style="height: 38px; width: 100%">查询</button>
                  </div>
                </div>
              </div>
            </div>
          </div><!-- .yoo-card -->
          <div class="yoo-height-b30 yoo-height-lg-b30"></div>
        </div>
      </div>
       <div class="row">
         <div class="col-lg-12">
          <div class="yoo-card yoo-style1">
            <div class="yoo-card-heading">
              <div class="yoo-card-heading-left">
                <h2 class="yoo-card-title"><span class="yoo-card-title-icon yoo-gray-bg"><ion-icon name="map"></ion-icon></span>客流量表单</h2>
              </div>
            </div>
            <div class="yoo-card-body">
              <div class="yoo-padd-lr-20">
                <div class="yoo-height-b20 yoo-height-lg-b20"></div>
                <div id="control-panel">
                  <div>
                    <label>时间</label>
                    <input id="time" type="range" min="1000" max="20000" step="1000" value="0"></input>
                    <span id="time-value">0</span>
                  </div>
                </div>
                <div id="traj-table" class="display" style="width: 100%; height: 500px;">
                </div>
              </div>
            </div>
          </div><!-- .yoo-card -->
          <div class="yoo-height-b30 yoo-height-lg-b30"></div>
        </div>
      </div>
    </div>
    <div class="yoo-height-b30 yoo-height-lg-b30"></div>

    {% include 'includes/footer.html' %}

  </div>    

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.4/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.4/js/buttons.html5.min.js"></script>
  <script type="text/javascript" src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>

  <script src="/static/assets/js/apexcharts.min.js"></script>
  <!-- <script src="/static/assets/js/apexcharts.initialize.js"></script> -->
  <script src="/static/assets/js/svg-maps/jquery.vmap.min.js"></script>
  <script src="/static/assets/js/svg-maps/jquery.vmap.usa.js"></script>
  <script src="/static/assets/js/svg-maps/jquery.vmap.main.js"></script>
  <!-- <script src="/static/assets/js/jquery.dataTables.min.js"></script> -->
  <!-- <script src="/static/assets/js/sheet-download-node.js"></script> -->
  <script type="text/javascript">

var currentTrips;
var currentPolys;
var startUnixTS;
var endUnixTS;
var cameraInfo;

function enumerateDaysBetweenDates (startDate, endDate){
  let date = []
  date.push(moment(startDate).format("YYYY-MM-DD"));
  while(moment(startDate) < moment(endDate)){
    startDate = moment(startDate).add(1, 'days').format("YYYY-MM-DD");
    date.push(startDate);
  }
  return date;
}

// load property_id from DB
function loadPropertyIDs()
{  
	alert(apisUrl + '/get_property')
  $.get(apisUrl + '/get_property', function(data, textStatus, jqXHR){
    $("#property_id_selector").empty(); 
    if (data.length != 0)
    {
      for (i in data) {   
        $('#property_id_selector').append($('<option>', {
            value: data[i].property_id,
            text: data[i].property_id
        }));
      }
      loadDateRangePicker($("#property_id_selector :selected").val())
      loadFloorIDs($("#property_id_selector :selected").val());
      $('#property_id_selector').change(function(){
        loadFloorIDs($("#property_id_selector :selected").val())
      });
      $('#floor_id_selector').change(function(){
        loadCameraIDs($("#floor_id_selector :selected").val())
      });
    }
  })
}

// load floor_id by property_id from DB
function loadFloorIDs(property_id)
{          
  $.post(apisUrl + '/get_floor', {'property_id': property_id}, function(data, textStatus, jqXHR){
    $("#floor_id_selector").empty();
    if (data.length != 0)
    {
      for (i in data) {
        $("#floor_id_selector").append(`<option value="` + data[i].floor_id + `">` + data[i].floor_id+"</option>");
      }
    }
    loadCameraIDs($("#floor_id_selector :selected").val())
  })
}

function loadCameraIDs(floor_id)
{
  $.post(apisUrl + '/get_camera', {'floor_id': floor_id}, function(data, textStatus, jqXHR){
    cameraInfo = data
    console.log(cameraInfo)
    $("#camera_id_selector").empty();
    if (data.length != 0)
    {
      for (i in data) {
        $("#camera_id_selector").append(`<option value="` + data[i].camera_id + `">` + data[i].camera_id+"</option>");
      }
    }
  })
}

const deckgl = new deck.DeckGL({
  container: 'traj-table',
  controller: true,
  initialViewState: {
    longitude: 0.5,
    latitude: 0.5,
    zoom: 9,
    maxZoom: 16
  }
});

const OPTIONS = ['time'];

OPTIONS.forEach(key => {
  document.getElementById(key).oninput = renderLayer;
});

function renderLayer(){
  const options = {};
  OPTIONS.forEach(key => {
    if (key == 'time'){
      const value = +document.getElementById(key).value;
      document.getElementById(key + '-value').innerHTML = value;
      options['currentTime'] = value;
    }
  });
  
  const polygonLayer = new deck.PolygonLayer({
    id: 'polygon-layer',
    data: currentPolys,
    pickable: true,
    stroked: true,
    filled: true,
    wireframe: true,
    lineWidthMinPixels: 1,
    getPolygon: d => d.coordinates,
    // getElevation: d => d.population / d.area / 10,
    // getFillColor: d => [d.population / d.area / 60, 140, 0],
    getFillColor: d => [140, 140, 40],
    getLineColor: [80, 80, 80],
    getLineWidth: 1,
    opacity: 0.4,
  });
  const tripsLayer = new deck.TripsLayer({
    id: 'trips-layer',
    data: currentTrips,
    getPath: d => d.waypoints.map(p => p.coordinates),
    // deduct start timestamp from each data point to avoid overflow
    getTimestamps: d => d.waypoints.map(p => p.timestamp - startUnixTS),
    getColor: [253, 128, 93],
    opacity: 0.8,
    widthMinPixels: 3,
    rounded: true,
    trailLength: 3000,
    ...options
  });

  deckgl.setProps({
    layers: [tripsLayer, polygonLayer]
  });
}

var table;
function loadDateRangePicker(property_id){
  $.post(apisUrl + '/get_available_date', {'property_id': property_id}, function(data, textStatus, jqXHR){
    $('input[name="daterange"]').daterangepicker({minDate:moment(data[0].start_date), maxDate:moment(data[0].end_date), timePicker: true});
    $("#search-traj").click(function(){
      // -----trips
      var startTime = $('input[name="daterange"]').data('daterangepicker').startDate.format('YYYY-MM-DD HHmmss')
      var endTime = $('input[name="daterange"]').data('daterangepicker').endDate.format('YYYY-MM-DD HHmmss')
      $.post(apisUrl + '/get_tracks', {'start_time': startTime, 'end_time': endTime, 'camera_id': $('#camera_id_selector :selected').val()}, function(data, textStatus, jqXHR){
          var re = new Array();
          var a = 0;
          re = []
          data.forEach(function(item, i){
            temp = {"waypoints": []}
            //zwang !!!! hard code 8 hours
            track = JSON.parse(item.track).coordinates
            track_ts = item.track_ts.replaceAll("'", '').replaceAll(`"`, ``).replaceAll(`{`, ``).replaceAll(`}`, ``).split(",")
            track.forEach(function(item, i){
              temp.waypoints.push({"coordinates": [track[i][0] * 1.3333333, 1 - track[i][1]], "timestamp": parseInt(moment(track_ts[i]).format('x'))});
            })
            re.push(temp);
            // re[a] = 
            // re[a]={'x': moment(item['end_time']).add(8, 'hours').format('YYYY-MM-DD HH:mm:ss'), 'y': item['enter_cnt']};
          });
          currentTrips=re;
          startUnixTS=parseInt($('input[name="daterange"]').data('daterangepicker').startDate.format('x'));
          endUnixTS=parseInt($('input[name="daterange"]').data('daterangepicker').endDate.format('x'));
          $('#time').attr('max', endUnixTS - startUnixTS);

          // ------polys
          var index = cameraInfo.findIndex(item => item.camera_id === $("#camera_id_selector :selected").val());
          var geometries = [JSON.parse(cameraInfo[index].custom_zone.split('":[')[2].split(']}]}')[0])]
          geometries.forEach(geometry => {
            geometry.forEach((coord, i) => {
              geometry[i] = [coord[0] * 1.0 / 480, 1 - coord[1] * 1.0 / 480]
            })
          });
          console.log(geometries)
          currentPolys = new Array()
          currentPolys.push({'coordinates': geometries})
          renderLayer();
      });

    });
  })
}

$(document).ready(function(){

  loadPropertyIDs();
});



</script>

{% endblock javascripts %}
